# fb2cut

Консольное приложение для перепаковки архивов библиотеки  

#### Что делает
* Извлекает содержимое книг в формате fb2, вырезая из них картинки (содержимое узлов binary)
* Картинки складывает отдельно - папка covers для обложек, images для остальных картинок
* Ресайзит картинки, если из размеры превышают указанные максимумы
* Пережимает картинки в JPEG XL с указанным качеством сжатия
* Архивирует избавленные от картинок fb2 в указанный формат (7z или zip)
* Можно указать внешний архиватор (например 7z.exe) и параметры командной строки для него. ВНИМАНИЕ! Не стоит делать архивы непрерывными (solid), иначе при показе аннотации и извлечении книг гарантированы тормоза.
* Справку по ключам командной строки можно получить запуском утилиты с ключом -h

#### А зачем всё это?
Для уменьшения размера библиотеки в байтах, конечно. Особенно, если не нужны картинки. Или если нужны только обложки. Или если установить разумные ограничения размеров изображений и качество сжатия. Но даже если оставить картинки в исходном размере, то всё равно будет ощутимый выигрыш от пережатия текстов в 7z и отдельного хранения изображений без кодирования в base64. Например, на момент разработки утилиты библиотека флибусты весит 448Г. После обработки утилитой без изменения размера картинок и умолчальном качестве сжатия имеем: fb2 в 7z - 70Г, обложки - 41Г, остальные картинки - 176Г, итого - 287Г. Уже неплохо. С ограничением для обложек 1024px, а для остальных картинок - 480px с качеством сжатия 25: обложки - 25Г, остальные картинки - 46Г, итого - 141Г. Ещё лучше. И для совсем крохоборов, можно сделать картинки чёрно-белыми: обложки - 22Г, остальные картинки - 44Г, итого 136Г. PROFIT!

#### И что потом делать с перепакованными архивами?
Используем их с FLibrary вместо исходных. Или с любым другим каталогизатором, который поддерживает указанный формат архивации, но книги будут без обложек и иллюстраций.

#### Что за файлы в папках error?
Там fb2, которые не удалось распарсить. Кривой xml, левая кодировка и т.п. Можно попробовать как-то починить и подложить в соответствующий архив. Или подложить битые. Там же извлечённые из fb2 битые картинки, т.е. содержимое узлов binary, которое не удалось декодировать. Действительно, в файлах библиотеки много мусора, не являющегося валидными файлами изображений. Или валидными, но не являющиеся изображениями: html, txt (текстовые копии книги), даже полноценные fb2 другой книги. Есть ещё вполне годные файлы в неподдерживаемом Qt формате, например riff. Их можно конвертнуть в JPEG XL каким-нибудь графическим редактором и подложить в соответствующий архив вручную. Или можно указать программе путь к ffmpeg.exe, который попытается декодировать или даже починить эти файлы. FFmpeg можно взять [тут](https://www.ffmpeg.org/). Но и FFmpeg не всесилен, бесповоротно битые файлы таковыми и останутся.

#### А что так долго-то?
Для Флибусты требуется кодирование +5М (+360Г) изображений в JPEG XL + 7z-архивация +66K (~500Г) fb2-файлов. Такое не может быть быстрым, может длиться несколько суток. К счастью, перекодировать всю библиотеку надо лишь один раз. Потом только файлы обновлений.

#### Примеры запуска с параметрами командной строки
```
fb2cut.exe D:\fb2.Flibusta.Net\*.zip -o D:\repacked --max-size 480 --max-cover-size 1024 --image-quality 25 --image-grayscale -a "C:\Program Files\7-Zip\7z.exe" --archiver-options "a %dst%.7z -mx9 -sdel -m0=PPMd -ms=off %src%" --ffmpeg C:\programs\ffmpeg\6.0\bin\ffmpeg.exe
```
```
fb2cut.exe --help
```
# flidumper

Консольное приложение для генерации базы данных по скриптам дампов Флибусты и Либрусека

# flihasher

Консольное приложение для парсинга архивов: сбор хэшей изображений и иерархии секций

# flimager

Консольное приложение для перекодирования картинок - смены размеров и качества

# flimerger

Консольное приложение для добавления в коллекцию новых архивов с поиском и устранением дублей

# fliparser

Консольное приложение для разбора дампов с Флибусты и генерации файлов для создания коллекции в FLibrary

# fliscaner

Консольное приложение для скачивания данных с Флибусты

# flistat

Консольное приложение для генерации базы данных из файла статистики картинок fb2cut.

# flicmp

Консольное приложение для извлечения "хэша" книги

# flifaqer

GUI-приложение, генератор FAQ. Подобие Qt-шного linguist'а, с ориентацией на формат "вопрос-ответ".

# Использование

## Инициализация
1. Скачиваем "оригинальные" раздачи
2. fliscaner: скачиваем архивы с дампами с Флибусты/Либрусека
3. flidumper: по дампам, полученным в п.3, генерим базы данных, дополнительную инфу (авторы, только для флибусты)
4. fb2cut: перепаковываем архивы, полученные в п.1, в 7z + zip с картинками
5. flihasher: по перепакованным архивам, полученным в п.4, генерим хэши книг
6. flimerger: помещаем архивы, полученные в п.4, в новое место хранения, используя бд и хэши, полученные в пп. 3 и 5
7. fliparser: для получившегося в п.6 набора архивов генерируем inpx, reviews, compilations, contents, etc, используем бд и хэши из пп. 3 и 6

NB Если нет цели отфильтровать дубли, то пп.5,6 выполнять не надо. А можно и не перекодировать, тогда п.4 тоже пропускаем.

## Регулярные обновления
1. fliscaner: скачиваем архивы с книгами с Флибусты/Либрусека, лучше ежедневно, по расписанию
2. fliscaner: скачиваем архивы с дампами с Флибусты/Либрусека
3. flidumper: по дампам, полученным в п.3, генерим базы данных, дополнительную инфу (авторы, только для флибусты)
4. fb2cut: перепаковываем архивы, полученные в п.1, в 7z + zip с картинками
5. flihasher: по перепакованным архивам, полученным в п.4, генерим хэши книг
6. flimerger: добавляем новые архивы, полученные в п.4, к уже имеющимся, используя бд и хэши, полученные в пп. 3 и 5
7. fliparser: для получившегося в п.6 набора архивов генерируем inpx, reviews, compilations, contents, etc, используем бд и хэши из пп. 3 и 6

NB Если нет цели отфильтровать дубли, то пп.5,6 выполнять не надо. А можно и не перекодировать, тогда п.4 тоже пропускаем.

## Мои батники и конфиги
[Тутъ](https://github.com/heimdallr/books-collection)
